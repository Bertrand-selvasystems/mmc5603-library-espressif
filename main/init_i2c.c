/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////// DEFINITION DES LIBRAIRIES
/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
#include "init_i2c.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////// DEFINITION DES VARIALES STATIC
/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
static const char *TAG = "I2C Init";

/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////// DEFINITION DES FONCTIONS
/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
/**
 * @brief Initialise le port I2C.
 *
 * Cette fonction configure le port I2C en tant que maître et installe le pilote I2C.
 *
 * @return `ESP_OK` si l'initialisation a réussi, sinon un code d'erreur esp_err_t.
 */
esp_err_t i2c_master_init() {
  i2c_config_t config = {
      .mode = I2C_MODE_MASTER,
      .sda_io_num = I2C_SDA_PIN,
      .scl_io_num = I2C_SCL_PIN,
      .sda_pullup_en = GPIO_PULLUP_ENABLE,  // GPIO_PULLUP_ENABLE si pas de résistance de pull-up de 4,7 kΩ entre 3,3 V et SDA
      .scl_pullup_en = GPIO_PULLUP_ENABLE,  // GPIO_PULLUP_ENABLE si pas de résistance de pull-up de 4,7 kΩ entre 3,3 V et SCL
      .master.clk_speed = I2C_MASTER_FREQ_HZ,
  };

  // Configure le port I2C avec les paramètres définis
  esp_err_t ret = i2c_param_config(I2C_PORT, &config);
  if (ret != ESP_OK) {
    ESP_LOGE(TAG, "Erreur lors de la configuration des paramètres I2C : %s", esp_err_to_name(ret));
    return ret;
  }

  // Installe le driver I2C
  ret = i2c_driver_install(I2C_PORT, I2C_MODE_MASTER, I2C_MASTER_RX_BUF_DISABLE, I2C_MASTER_TX_BUF_DISABLE, 0);
  if (ret != ESP_OK) {
    ESP_LOGE(TAG, "Erreur lors de l'installation du pilote I2C : %s", esp_err_to_name(ret));
    return ret;
  }

  ESP_LOGI(TAG, "Port I2C initialisé avec succès");
  return ESP_OK;
}
